<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONNX Runtime Web Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h2 {
            color: #333;
            margin-top: 0;
        }
        .provider-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .provider-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .provider-card h3 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .model-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .model-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .model-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
        }
        .response-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ONNX Runtime Web Test</h1>
        <p>This page demonstrates the ONNX Runtime Web integration with provider priority: WebNN (NPU/GPU) → WebGPU → WASM</p>

        <div class="section">
            <h2>Provider Information</h2>
            <div id="providerInfo" class="provider-info">
                <div class="provider-card">
                    <h3>WebNN</h3>
                    <p>Status: <span id="webnnStatus">Checking...</span></p>
                    <p>Preferred Device: <span id="webnnDevice">-</span></p>
                    <p>Available Devices: <span id="webnnDevices">-</span></p>
                </div>
                <div class="provider-card">
                    <h3>WebGPU</h3>
                    <p>Status: <span id="webgpuStatus">Checking...</span></p>
                    <p>Adapter: <span id="webgpuAdapter">-</span></p>
                </div>
                <div class="provider-card">
                    <h3>WASM</h3>
                    <p>Status: <span id="wasmStatus">Checking...</span></p>
                    <p>Threads: <span id="wasmThreads">-</span></p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Available Models</h2>
            <div id="modelList" class="model-list">
                <!-- Models will be loaded here -->
            </div>
        </div>

        <div class="section">
            <h2>Model Testing</h2>
            <div>
                <label for="modelSelect">Select Model:</label>
                <select id="modelSelect">
                    <option value="">Choose a model...</option>
                </select>
                <button id="loadModelBtn">Load Model</button>
                <button id="unloadModelBtn">Unload Model</button>
            </div>
            <div id="modelStatus" class="status info" style="display: none;">
                <!-- Model status will be shown here -->
            </div>
        </div>

        <div class="section">
            <h2>Inference Test</h2>
            <div>
                <label for="testInput">Input Message:</label>
                <textarea id="testInput" placeholder="Enter your message here...">Hello, how are you today?</textarea>
                <button id="generateBtn">Generate Response</button>
            </div>
            <div id="responseArea" class="response-area" style="display: none;">
                <!-- Response will be shown here -->
            </div>
        </div>

        <div class="section">
            <h2>Cache Management</h2>
            <div>
                <button id="getCacheStatsBtn">Get Cache Stats</button>
                <button id="getCachedModelsBtn">Get Cached Models</button>
                <button id="clearAllCacheBtn">Clear All Cache</button>
                <button id="cleanupOldCacheBtn">Cleanup Old Models</button>
            </div>
            <div id="cacheInfo" class="status info" style="display: none;">
                <!-- Cache info will be shown here -->
            </div>
        </div>

        <div class="section">
            <h2>System Information</h2>
            <div id="systemInfo">
                <!-- System info will be loaded here -->
            </div>
        </div>
    </div>

    <script type="module">
        // This is a demo script that would normally interact with the extension
        // In a real implementation, this would communicate with the background script
        
        class ONNXTestPage {
            constructor() {
                this.initializeUI()
                this.checkProviders()
                this.loadSystemInfo()
            }

            initializeUI() {
                // Initialize model list
                this.updateModelList()
                
                // Set up event listeners
                document.getElementById('loadModelBtn').addEventListener('click', () => this.loadModel())
                document.getElementById('unloadModelBtn').addEventListener('click', () => this.unloadModel())
                document.getElementById('generateBtn').addEventListener('click', () => this.generateResponse())
                
                // Cache management event listeners
                document.getElementById('getCacheStatsBtn').addEventListener('click', () => this.getCacheStats())
                document.getElementById('getCachedModelsBtn').addEventListener('click', () => this.getCachedModels())
                document.getElementById('clearAllCacheBtn').addEventListener('click', () => this.clearAllCache())
                document.getElementById('cleanupOldCacheBtn').addEventListener('click', () => this.cleanupOldCache())
            }

            async checkProviders() {
                // Check WebNN availability
                const webnnStatus = document.getElementById('webnnStatus')
                const webnnDevice = document.getElementById('webnnDevice')
                const webnnDevices = document.getElementById('webnnDevices')

                                 if (typeof navigator.ml !== 'undefined') {
                     webnnStatus.textContent = 'Available'
                     webnnStatus.style.color = 'green'
                     
                     // Mock device detection
                     webnnDevice.textContent = 'NPU (Qualcomm)'
                     webnnDevices.textContent = 'NPU, GPU, CPU'
                 } else {
                     webnnStatus.textContent = 'Not Available'
                     webnnStatus.style.color = 'red'
                 }

                 // Check WebGPU availability
                 const webgpuStatus = document.getElementById('webgpuStatus')
                 const webgpuAdapter = document.getElementById('webgpuAdapter')

                 if (navigator.gpu) {
                     try {
                         const adapter = await navigator.gpu.requestAdapter()
                         if (adapter) {
                             webgpuStatus.textContent = 'Available'
                             webgpuStatus.style.color = 'green'
                             webgpuAdapter.textContent = adapter.name || 'Unknown GPU'
                         } else {
                             webgpuStatus.textContent = 'No Compatible GPU'
                             webgpuStatus.style.color = 'orange'
                         }
                     } catch (error) {
                         webgpuStatus.textContent = 'Error'
                         webgpuStatus.style.color = 'red'
                     }
                 } else {
                     webgpuStatus.textContent = 'Not Available'
                     webgpuStatus.style.color = 'red'
                 }

                // Check WASM availability
                const wasmStatus = document.getElementById('wasmStatus')
                const wasmThreads = document.getElementById('wasmThreads')

                if (typeof WebAssembly !== 'undefined') {
                    wasmStatus.textContent = 'Available'
                    wasmStatus.style.color = 'green'
                    wasmThreads.textContent = navigator.hardwareConcurrency || 'Unknown'
                } else {
                    wasmStatus.textContent = 'Not Available'
                    wasmStatus.style.color = 'red'
                }
            }

            updateModelList() {
                const models = [
                    {
                        id: 'tinyllama-1.1b-chat',
                        name: 'TinyLlama 1.1B Chat',
                        description: 'A small, fast language model for chat applications',
                        size: '1.1B parameters',
                        provider: 'webnn'
                    },
                    {
                        id: 'llama-2-7b-chat',
                        name: 'Llama 2 7B Chat',
                        description: 'Medium-sized language model with good performance',
                        size: '7B parameters',
                        provider: 'webgpu'
                    },
                    {
                        id: 'gpt-2-small',
                        name: 'GPT-2 Small',
                        description: 'Small GPT-2 model for text generation',
                        size: '117M parameters',
                        provider: 'wasm'
                    }
                ]

                const modelList = document.getElementById('modelList')
                modelList.innerHTML = ''

                models.forEach(model => {
                    const card = document.createElement('div')
                    card.className = 'model-card'
                    card.innerHTML = `
                        <h4>${model.name}</h4>
                        <p>${model.description}</p>
                        <p><strong>Size:</strong> ${model.size}</p>
                        <p><strong>Provider:</strong> ${model.provider}</p>
                        <button onclick="window.testPage.loadSpecificModel('${model.id}')">Load</button>
                    `
                    modelList.appendChild(card)
                })

                // Update select dropdown
                const select = document.getElementById('modelSelect')
                select.innerHTML = '<option value="">Choose a model...</option>'
                models.forEach(model => {
                    const option = document.createElement('option')
                    option.value = model.id
                    option.textContent = model.name
                    select.appendChild(option)
                })
            }

            async loadModel() {
                const modelId = document.getElementById('modelSelect').value
                if (!modelId) {
                    this.showStatus('Please select a model first', 'error')
                    return
                }

                this.showStatus(`Loading model: ${modelId}...`, 'info')
                
                // Simulate loading process
                await this.simulateLoading(modelId)
                
                this.showStatus(`Model ${modelId} loaded successfully!`, 'success')
            }

                         async loadSpecificModel(modelId) {
                 this.showStatus(`Loading model: ${modelId}...`, 'info')
                 
                 // Simulate loading process
                 await this.simulateLoading(modelId)
                 
                 this.showStatus(`Model ${modelId} loaded successfully!`, 'success')
             }

             async simulateLoading(modelId) {
                 const statusDiv = document.getElementById('modelStatus')
                 statusDiv.style.display = 'block'
                 
                 // Simulate progress
                 for (let i = 0; i <= 100; i += 10) {
                     statusDiv.innerHTML = `
                         <div>Loading ${modelId}...</div>
                         <div class="progress-bar">
                             <div class="progress-fill" style="width: ${i}%"></div>
                         </div>
                         <div>${i}% complete</div>
                     `
                     await new Promise(resolve => setTimeout(resolve, 200))
                 }
             }

             async unloadModel() {
                 const modelId = document.getElementById('modelSelect').value
                 if (!modelId) {
                     this.showStatus('Please select a model first', 'error')
                     return
                 }

                 this.showStatus(`Unloading model: ${modelId}...`, 'info')
                 
                 // Simulate unloading
                 await new Promise(resolve => setTimeout(resolve, 1000))
                 
                 this.showStatus(`Model ${modelId} unloaded successfully!`, 'success')
             }

             async generateResponse() {
                 const input = document.getElementById('testInput').value
                 if (!input.trim()) {
                     this.showStatus('Please enter a message', 'error')
                     return
                 }

                 const modelId = document.getElementById('modelSelect').value
                 if (!modelId) {
                     this.showStatus('Please select a model first', 'error')
                     return
                 }

                 this.showStatus('Generating response...', 'info')
                 
                 // Simulate inference
                 await new Promise(resolve => setTimeout(resolve, 2000))
                 
                 // Mock response based on provider
                 const responses = {
                     'tinyllama-1.1b-chat': `This response was generated using WebNN acceleration for optimal performance. (Model: ${modelId}, Provider: webnn)`,
                     'llama-2-7b-chat': `This response was generated using WebGPU acceleration for high-performance inference. (Model: ${modelId}, Provider: webgpu)`,
                     'gpt-2-small': `This response was generated using WebAssembly for cross-platform compatibility. (Model: ${modelId}, Provider: wasm)`
                 }
                 
                 const response = responses[modelId] || `Generated response for: "${input}" (Model: ${modelId})`
                 
                 const responseArea = document.getElementById('responseArea')
                 responseArea.style.display = 'block'
                 responseArea.textContent = response
                 
                 this.showStatus('Response generated successfully!', 'success')
             }

             showStatus(message, type) {
                 const statusDiv = document.getElementById('modelStatus')
                 statusDiv.style.display = 'block'
                 statusDiv.className = `status ${type}`
                 statusDiv.textContent = message
             }

             loadSystemInfo() {
                 const systemInfo = document.getElementById('systemInfo')
                 systemInfo.innerHTML = `
                     <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                     <p><strong>Platform:</strong> ${navigator.platform}</p>
                     <p><strong>Hardware Concurrency:</strong> ${navigator.hardwareConcurrency || 'Unknown'}</p>
                     <p><strong>Memory:</strong> ${performance.memory ? `${Math.round(performance.memory.usedJSHeapSize / 1024 / 1024)}MB / ${Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)}MB` : 'Unknown'}</p>
                     <p><strong>WebNN Available:</strong> ${typeof navigator.ml !== 'undefined' ? 'Yes' : 'No'}</p>
                     <p><strong>WebGPU Available:</strong> ${typeof navigator.gpu !== 'undefined' ? 'Yes' : 'No'}</p>
                                      <p><strong>WebAssembly Available:</strong> ${typeof WebAssembly !== 'undefined' ? 'Yes' : 'No'}</p>
                 `
             }

             // Cache management methods
             async getCacheStats() {
                 this.showStatus('Getting cache stats...', 'info')
                 
                 // Simulate cache stats
                 const stats = {
                     totalSize: 2048576, // 2MB
                     modelCount: 2,
                     availableSpace: 3145728 // 3MB remaining
                 }
                 
                 const cacheInfo = document.getElementById('cacheInfo')
                 cacheInfo.style.display = 'block'
                 cacheInfo.className = 'status success'
                 cacheInfo.innerHTML = `
                     <h3>Cache Statistics</h3>
                     <p><strong>Total Size:</strong> ${this.formatBytes(stats.totalSize)}</p>
                     <p><strong>Model Count:</strong> ${stats.modelCount}</p>
                     <p><strong>Available Space:</strong> ${this.formatBytes(stats.availableSpace)}</p>
                     <p><strong>Usage:</strong> ${Math.round((stats.totalSize / (5 * 1024 * 1024)) * 100)}%</p>
                 `
             }

             async getCachedModels() {
                 this.showStatus('Getting cached models...', 'info')
                 
                 // Simulate cached models
                 const models = [
                     {
                         id: 'tinyllama-1.1b-chat',
                         name: 'TinyLlama 1.1B Chat',
                         size: 1048576, // 1MB
                         provider: 'webnn',
                         timestamp: Date.now() - 86400000 // 1 day ago
                     },
                     {
                         id: 'gpt-2-small',
                         name: 'GPT-2 Small',
                         size: 1000000, // ~1MB
                         provider: 'wasm',
                         timestamp: Date.now() - 172800000 // 2 days ago
                     }
                 ]
                 
                 const cacheInfo = document.getElementById('cacheInfo')
                 cacheInfo.style.display = 'block'
                 cacheInfo.className = 'status success'
                 cacheInfo.innerHTML = `
                     <h3>Cached Models</h3>
                     ${models.map(model => `
                         <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                             <p><strong>${model.name}</strong></p>
                             <p>Size: ${this.formatBytes(model.size)}</p>
                             <p>Provider: ${model.provider}</p>
                             <p>Cached: ${new Date(model.timestamp).toLocaleString()}</p>
                         </div>
                     `).join('')}
                 `
             }

             async clearAllCache() {
                 this.showStatus('Clearing all cache...', 'info')
                 
                 // Simulate clearing
                 await new Promise(resolve => setTimeout(resolve, 1000))
                 
                 this.showStatus('All cached models cleared successfully!', 'success')
                 
                 const cacheInfo = document.getElementById('cacheInfo')
                 cacheInfo.style.display = 'block'
                 cacheInfo.className = 'status success'
                 cacheInfo.innerHTML = `
                     <h3>Cache Cleared</h3>
                     <p>All cached models have been removed.</p>
                 `
             }

             async cleanupOldCache() {
                 this.showStatus('Cleaning up old models...', 'info')
                 
                 // Simulate cleanup
                 await new Promise(resolve => setTimeout(resolve, 1000))
                 
                 this.showStatus('Old models cleaned up successfully!', 'success')
                 
                 const cacheInfo = document.getElementById('cacheInfo')
                 cacheInfo.style.display = 'block'
                 cacheInfo.className = 'status success'
                 cacheInfo.innerHTML = `
                     <h3>Cleanup Complete</h3>
                     <p>Old cached models have been removed.</p>
                 `
             }

             formatBytes(bytes) {
                 if (bytes === 0) return '0 Bytes'
                 
                 const k = 1024
                 const sizes = ['Bytes', 'KB', 'MB', 'GB']
                 const i = Math.floor(Math.log(bytes) / Math.log(k))
                 
                 return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
             }
         }

        // Initialize the test page
        window.testPage = new ONNXTestPage()
    </script>
</body>
</html> 